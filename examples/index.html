<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8 />
    <title>Windy Demo</title>
    <link rel='stylesheet' href='css/style.css'>
  </head>

  <body onload='initMap()'>
    <div id='map' />
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.3.10/d3.min.js" charset="utf-8"></script>
    <script src='https://rawgithub.com/stamen/modestmaps-js/master/modestmaps.min.js'></script>
    <script src='../windy.js'></script>
    <script>
      var map, windy;
  
      function initMap(){
        var provider = new com.modestmaps.TemplatedLayer('http://freshymap.com/tiles/{Y}/{X}/{Z}.png');
        map = new com.modestmaps.Map('map', provider); 
        //map.setCenterZoom(new MM.Location( 39, -99), 2);
        map.setCenterZoom(new MM.Location( 0, 0), 2);

        var canvas = document.createElement('canvas');

        // get corner positions 
        var global = [[-179, 79],[ 179, -79]];
        canvas.style.border = '2px solid red';
        canvas.style.position = 'absolute';
        map.parent.appendChild(canvas);


        d3.json('./data/gfs.json', function(err, data){
          windy = new Windy({canvas: canvas, data: data});
          update();
        });

        var adjustTO;
      
        function update() {
          var ctx = canvas.getContext('2d');
          ctx.clearRect(0,0,canvas.width,canvas.height);
          
          if ( typeof( adjustTO ) != 'undefined' ) window.clearTimeout(adjustTO);

          adjustTO = setTimeout(function(){

            var ul = map.locationPoint( new MM.Location(global[0][1], global[0][0]));
            var lr = map.locationPoint( new MM.Location(global[1][1], global[1][0]));
            var width = lr.x - ul.x;
            var height = lr.y - ul.y;
            canvas.style.left = ul.x+'px';
            canvas.style.top = ul.y+'px';
            canvas.width = width;
            canvas.height = height;
            adjustTO = undefined;

            console.log(width, height)

            if ( windy ){
              var size = map.dimensions;
              //var extent = map.getExtent();
              //var ul = map.locationPoint(extent.northWest());
              //var lr = map.locationPoint(extent.southEast());
              windy.update( [[ ul.x, ul.y ], [ lr.x, lr.y ]], width, height );
            }

          }, 200);

          //ctx.strokeStyle = '#404040';
          //ctx.beginPath();
          //var p = map.locationPoint(locations[0]);
          //ctx.moveTo(p.x,p.y);
          //for (var i = 1; i < locations.length; i++) {
          //  p = map.locationPoint(locations[i]);
          //  ctx.lineTo(p.x,p.y);
          //}
          //ctx.stroke();
        }
      
        map.addCallback('drawn', update);
        map.addCallback('resized', function() {
          canvas.width = map.dimensions.x;
          canvas.height = map.dimensions.y;
          update();
        });
      
        update( );
      }
    </script>
  </body>
</html>

